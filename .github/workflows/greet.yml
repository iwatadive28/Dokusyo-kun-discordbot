name: Weekly Reading Group Greetings

on:
  schedule:
    # - cron: '0 12 * * 5'    # é‡‘æ›œ21:00 JST â†’ day_before
    # - cron: '0 22 * * 5'    # åœŸæ›œ07:00 JST â†’ start_notice
    # - cron: '55 22 * * 5'   # åœŸæ›œ07:55 JST â†’ end_notice
    - cron: '40 7 * * 0'    # æ—¥æ›œ16:35 JST
    - cron: '41 7 * * 0'    # æ—¥æ›œ16:36 JST
    - cron: '42 7 * * 0'    # æ—¥æ›œ16:37 JST
  workflow_dispatch:
    inputs:
      mode:
        description: 'æŠ•ç¨¿ãƒ¢ãƒ¼ãƒ‰ï¼ˆday_before / start_notice / end_noticeï¼‰'
        required: true
        type: string

jobs:
  greet:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v3

      - name: ğŸ Python ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: ğŸ“š ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: pip install -r requirements.txt

      - name: ğŸ¤– ã‚ã„ã•ã¤ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŠ•ç¨¿
        run: |
          MODE="${{ github.event.inputs.mode }}"
          if [ -z "$MODE" ]; then
            # ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œæ™‚ã®åˆ¤å®šï¼ˆUTCãƒ™ãƒ¼ã‚¹ï¼‰
            HOUR=$(date -u +"%H")
            MIN=$(date -u +"%M")
            DOW=$(date -u +"%w")  # 0=Sun, 1=Mon, ..., 6=Sat
             
            # ãƒ†ã‚¹ãƒˆç”¨: æ—¥æ›œ JST 16:40ã€œ16:42 â†’ UTC 7:40ã€œ7:42
            if [ "$DOW" = "0" ] && [ "$HOUR" = "7" ] && [ "$MIN" = "40" ]; then
              MODE="day_before"
            elif [ "$DOW" = "0" ] && [ "$HOUR" = "7" ] && [ "$MIN" = "41" ]; then
              MODE="start_notice"
            elif [ "$DOW" = "0" ] && [ "$HOUR" = "7" ] && [ "$MIN" = "42" ]; then
              MODE="end_notice"
            else
              echo "âŒ å®Ÿè¡Œæ™‚åˆ»ã«å¯¾å¿œã™ã‚‹ãƒ¢ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
              exit 1
            fi
 
            # æœ¬ç•ªç”¨æ¡ä»¶ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼‰
            # if [ "$DOW" = "5" ] && [ "$HOUR" = "12" ]; then
            #   MODE="day_before"
            # elif [ "$DOW" = "5" ] && [ "$HOUR" = "22" ] && [ "$MIN" = "00" ]; then
            #  MODE="start_notice"
            # elif [ "$DOW" = "5" ] && [ "$HOUR" = "22" ] && [ "$MIN" = "55" ]; then
            #   MODE="end_notice"
            # else
            #  echo "âŒ å®Ÿè¡Œæ™‚åˆ»ã«å¯¾å¿œã™ã‚‹ãƒ¢ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            #   exit 1
            # fi            
          fi

          echo "ğŸŸ¢ å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰: $MODE"
          python greet.py "$MODE"
        env:
          DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
          DISCORD_CHANNEL_ID_TEST: ${{ secrets.DISCORD_CHANNEL_ID_TEST }}
